<!---
@title URL路由设计
@category 开发手册
@tags lua,programming,web
-->
<p>本文是在阅读<a href="https://github.com/APItools/router.lua">router.lua</a>源码时整理，一是为了帮助自己理解源码设计；二是为需要了解 Web URL 路由设计思路的同学提供参考。</p>
<p>若有错误请向我指出，谢谢。（邮箱：<a href="mailto:noodles.v6@gmail.com">noodles.v6@gmail.com</a>）</p>
<h2>设计思路</h2>
<p>思路：</p>
<ol>
<li>预先定义一套路由规则，预加载到内存中；</li>
<li>拦截HTTP请求，进行规则匹配；</li>
</ol>
<p>针对不同的Web平台架构，实现上可能有区别，但要做的事情主要是这两件。如：J2EE架构下，我们可以通过定义Servlet/Filter/Interceptor完成对HTTP请求的拦截。</p>
<p>这里我们基于Ngnix平台，针对开源项目<a href="https://github.com/APItools/router.lua">router.lua</a>简单介绍下实现逻辑。</p>
<h2 id="router.lua">router.lua</h2>
<h3>介绍</h3>
<p><a href="https://github.com/APItools/router.lua">router.lua</a>是一个非常基础的路由，lua语言开发。</p>
<p>特性：</p>
<ul>
<li>允许绑定 HTTP 请求到指定的函数。</li>
<li>支持参数化 URL，如：/app/services/:service_id</li>
<li>平台无关的，但是在 OpenResty 平台下测试的。</li>
</ul>
<h3>路由规则</h3>
<p>假设路由支持如下 URL 规则：</p>
<pre><code>GET  /hello
GET  /hello/*
GET  /hello/:name
POST /app/:id/comments</code></pre>
<p>router.lua会把 path 的每个<code>子目录</code>抽象成<code>Json node</code>，从而构造如下的数据结构：</p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
  <span class="dt">&quot;POST&quot;</span><span class="fu">:</span> <span class="fu">{</span>
    <span class="dt">&quot;app&quot;</span><span class="fu">:</span> <span class="fu">{</span>
      <span class="dt">&quot;TOKEN&quot;</span><span class="fu">:</span> <span class="fu">{</span>
        <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="fu">{</span>
          <span class="dt">&quot;comments&quot;</span><span class="fu">:</span> <span class="fu">{</span>
            <span class="dt">&quot;LEAF&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;function: 0x08053d58&gt;&quot;</span>
          <span class="fu">}</span>
        <span class="fu">}</span>
      <span class="fu">}</span>
    <span class="fu">}</span>
  <span class="fu">},</span>
  <span class="dt">&quot;GET&quot;</span><span class="fu">:</span> <span class="fu">{</span>
    <span class="dt">&quot;hello&quot;</span><span class="fu">:</span> <span class="fu">{</span>
      <span class="dt">&quot;WILDCARD&quot;</span><span class="fu">:</span> <span class="fu">{</span>
        <span class="dt">&quot;TOKEN&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;LEAF&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;function: 0x0515bfa0&gt;&quot;</span>
      <span class="fu">},</span>
      <span class="dt">&quot;TOKEN&quot;</span><span class="fu">:</span> <span class="fu">{</span>
        <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="fu">{</span>
          <span class="dt">&quot;LEAF&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;function: 0x08051dd8&gt;&quot;</span>
        <span class="fu">}</span>
      <span class="fu">},</span>
      <span class="dt">&quot;LEAF&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;function: 0x08053180&gt;&quot;</span>
    <span class="fu">}</span>
  <span class="fu">}</span>
<span class="fu">}</span></code></pre></div>
<p>lua代码实现：</p>
<div class="sourceCode"><pre class="sourceCode lua"><code class="sourceCode lua"><span class="kw">local</span> <span class="kw">function</span> match_one_path<span class="ot">(</span>node<span class="ot">,</span> path<span class="ot">,</span> f<span class="ot">)</span>
    <span class="kw">for</span> token <span class="kw">in</span> path:gmatch<span class="ot">(</span><span class="st">&quot;[^/.]+&quot;</span><span class="ot">)</span> <span class="kw">do</span>
        <span class="kw">if</span> WILDCARD_BYTE <span class="ot">==</span> token:byte<span class="ot">(</span><span class="dv">1</span><span class="ot">)</span> <span class="kw">then</span>
            node<span class="ot">[</span><span class="st">&#39;WILDCARD&#39;</span><span class="ot">]</span> <span class="ot">=</span> <span class="ot">{[</span><span class="st">&#39;LEAF&#39;</span><span class="ot">]</span> <span class="ot">=</span> f<span class="ot">,</span> <span class="ot">[</span><span class="st">&#39;TOKEN&#39;</span><span class="ot">]</span> <span class="ot">=</span> token:sub<span class="ot">(</span><span class="dv">2</span><span class="ot">)}</span>
            <span class="kw">return</span>
        <span class="kw">end</span>
        <span class="kw">if</span> COLON_BYTE <span class="ot">==</span> token:byte<span class="ot">(</span><span class="dv">1</span><span class="ot">)</span> <span class="kw">then</span>
            node<span class="ot">[</span><span class="st">&#39;TOKEN&#39;</span><span class="ot">]</span> <span class="ot">=</span> node<span class="ot">[</span><span class="st">&#39;TOKEN&#39;</span><span class="ot">]</span> <span class="kw">or</span> <span class="ot">{}</span>
            token <span class="ot">=</span> token:sub<span class="ot">(</span><span class="dv">2</span><span class="ot">)</span>
            node <span class="ot">=</span> node<span class="ot">[</span><span class="st">&#39;TOKEN&#39;</span><span class="ot">]</span>
        <span class="kw">end</span>
        node<span class="ot">[</span>token<span class="ot">]</span> <span class="ot">=</span> node<span class="ot">[</span>token<span class="ot">]</span> <span class="kw">or</span> <span class="ot">{}</span>
        node <span class="ot">=</span> node<span class="ot">[</span>token<span class="ot">]</span>
    <span class="kw">end</span>
    node<span class="ot">[</span><span class="st">&#39;LEAF&#39;</span><span class="ot">]</span> <span class="ot">=</span> f
<span class="kw">end</span></code></pre></div>
<h2>用户接口</h2>
<p>先定义<code>路由规则</code>：</p>
<div class="sourceCode"><pre class="sourceCode lua"><code class="sourceCode lua"><span class="kw">function</span> Router:match<span class="ot">(</span>method<span class="ot">,</span> path<span class="ot">,</span> fun<span class="ot">)</span>
    <span class="kw">if</span> <span class="fu">type</span><span class="ot">(</span>method<span class="ot">)</span> <span class="ot">==</span> <span class="st">&#39;string&#39;</span> <span class="kw">then</span>
        method <span class="ot">=</span> <span class="ot">{</span> <span class="ot">[</span>method<span class="ot">]</span> <span class="ot">=</span> <span class="ot">{[</span>path<span class="ot">]</span> <span class="ot">=</span> fun<span class="ot">}</span> <span class="ot">}</span>
    <span class="kw">end</span>

    <span class="kw">for</span> m<span class="ot">,</span> routes <span class="kw">in</span> <span class="fu">pairs</span><span class="ot">(</span>method<span class="ot">)</span> <span class="kw">do</span>
        <span class="kw">for</span> p<span class="ot">,</span> f <span class="kw">in</span> <span class="fu">pairs</span><span class="ot">(</span>routes<span class="ot">)</span> <span class="kw">do</span>
            <span class="kw">if</span> <span class="kw">not</span> self<span class="ot">.</span>_tree<span class="ot">[</span>m<span class="ot">]</span> <span class="kw">then</span> self<span class="ot">.</span>_tree<span class="ot">[</span>m<span class="ot">]</span> <span class="ot">=</span> <span class="ot">{}</span> <span class="kw">end</span>
            match_one_path<span class="ot">(</span>self<span class="ot">.</span>_tree<span class="ot">[</span>m<span class="ot">],</span> p<span class="ot">,</span> f<span class="ot">)</span>
        <span class="kw">end</span>
    <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<p>定义示例：</p>
<div class="sourceCode"><pre class="sourceCode lua"><code class="sourceCode lua"><span class="do">-- GET /hello</span>
router:match<span class="ot">(</span><span class="st">&#39;GET&#39;</span><span class="ot">,</span> <span class="st">&#39;/hello&#39;</span><span class="ot">,</span> <span class="kw">function</span><span class="ot">(</span>params<span class="ot">)</span>
    <span class="fu">print</span><span class="ot">(</span><span class="st">&quot;hello&quot;</span><span class="ot">)</span>
<span class="kw">end</span><span class="ot">)</span>

<span class="do">-- GET /hello/:name</span>
router:match<span class="ot">(</span><span class="st">&#39;GET&#39;</span><span class="ot">,</span> <span class="st">&#39;/hello/:name&#39;</span><span class="ot">,</span> <span class="kw">function</span><span class="ot">(</span>params<span class="ot">)</span>
    <span class="fu">print</span><span class="ot">(</span><span class="st">&quot;hello&quot;</span> <span class="ot">..</span> params<span class="ot">.</span>name<span class="ot">)</span>
<span class="kw">end</span><span class="ot">)</span>

<span class="do">-- POST /app/:id/comments</span>
router:match<span class="ot">(</span><span class="st">&#39;POST&#39;</span><span class="ot">,</span> <span class="st">&#39;/app/:id/comments&#39;</span><span class="ot">,</span> <span class="kw">function</span><span class="ot">(</span>params<span class="ot">)</span>
    <span class="fu">print</span><span class="ot">(</span><span class="st">&quot;comment &quot;</span> <span class="ot">..</span> params<span class="ot">.</span>comment <span class="ot">..</span> <span class="st">&#39; created&#39;</span><span class="ot">)</span>
<span class="kw">end</span><span class="ot">)</span></code></pre></div>
<p>路由定义好，我们该考虑如何使用规则了，即：对http请求，根据请求方法和请求uri匹配到规则，然后调用规则中的处理函数：</p>
<div class="sourceCode"><pre class="sourceCode lua"><code class="sourceCode lua"><span class="kw">function</span> Router:<span class="fu">execute</span><span class="ot">(</span>method<span class="ot">,</span> path<span class="ot">,</span> <span class="ot">...)</span>
    <span class="kw">local</span> f<span class="ot">,</span> params <span class="ot">=</span> self:resolve<span class="ot">(</span>method<span class="ot">,</span> path<span class="ot">,</span> <span class="ot">...)</span>
    <span class="kw">if</span> <span class="kw">not</span> f <span class="kw">then</span> <span class="kw">return</span> <span class="kw">nil</span><span class="ot">,</span> <span class="ot">(</span><span class="st">&#39;Could not resolve %s %s - %s&#39;</span><span class="ot">)</span>:<span class="fu">format</span><span class="ot">(</span><span class="fu">tostring</span><span class="ot">(</span>method<span class="ot">),</span> <span class="fu">tostring</span><span class="ot">(</span>path<span class="ot">),</span> <span class="fu">tostring</span><span class="ot">(</span>params<span class="ot">))</span> <span class="kw">end</span>
    <span class="kw">return</span> <span class="kw">true</span><span class="ot">,</span> f<span class="ot">(</span>params<span class="ot">)</span>
<span class="kw">end</span></code></pre></div>
<p>调用示例：</p>
<div class="sourceCode"><pre class="sourceCode lua"><code class="sourceCode lua">router:<span class="fu">execute</span><span class="ot">(</span><span class="st">&#39;GET&#39;</span><span class="ot">,</span> <span class="st">&#39;/hello&#39;</span><span class="ot">)</span>
router:<span class="fu">execute</span><span class="ot">(</span><span class="st">&#39;GET&#39;</span><span class="ot">,</span> <span class="st">&#39;/hello/fonlang&#39;</span><span class="ot">)</span>
router:<span class="fu">execute</span><span class="ot">(</span><span class="st">&#39;POST&#39;</span><span class="ot">,</span> <span class="ot">/</span>app<span class="ot">/</span><span class="dv">4</span><span class="ot">/</span>comments<span class="st">&#39;, { comment = &#39;</span>fascinating<span class="st">&#39; })</span></code></pre></div>
<h2>感想</h2>
<p>接口和数据结构是架构设计中极其重要的东西：</p>
<ul>
<li>接口表达了我们想如何使用</li>
<li>数据结构表达了我们该如何实现</li>
</ul>
<h2>更多</h2>
<ul>
<li><a href="https://news.ycombinator.com/item?id=7647595">Hacker News - A small router for Openresty</a></li>
<li><a href="https://www.mattcutts.com/blog/seo-glossary-url-definitions/">Talk like a Googler: parts of a url</a></li>
</ul>
